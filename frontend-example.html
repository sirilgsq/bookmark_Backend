<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Google Authentication Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .google-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .google-btn:hover {
            background-color: #357ae8;
        }
        .user-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            display: none;
        }
        .error {
            color: #d32f2f;
            margin-top: 10px;
        }
        .success {
            color: #2e7d32;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firebase Google Authentication</h1>
        <p>Click the button below to sign in with Google:</p>
        
        <button id="googleSignInBtn" class="google-btn">
            Sign in with Google
        </button>
        
        <div id="status"></div>
        
        <div id="userInfo" class="user-info">
            <h3>User Information:</h3>
            <p><strong>Name:</strong> <span id="userName"></span></p>
            <p><strong>Email:</strong> <span id="userEmail"></span></p>
            <p><strong>UID:</strong> <span id="userUid"></span></p>
            <button id="signOutBtn" class="google-btn" style="background-color: #dc3545;">
                Sign Out
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js';

        // Your Firebase config (replace with your actual config)
        const firebaseConfig = {
            // Replace these with your actual Firebase project config
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Your backend API endpoint (replace with your actual endpoint)
        const API_BASE_URL = 'https://your-region-your-project.cloudfunctions.net/api';
        // For local development, use: 'http://localhost:5001/your-project/region/api'

        // DOM elements
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const statusDiv = document.getElementById('status');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const userEmailSpan = document.getElementById('userEmail');
        const userUidSpan = document.getElementById('userUid');

        // Sign in with Google
        googleSignInBtn.addEventListener('click', async () => {
            try {
                showStatus('Signing in...', 'info');
                
                // Sign in with Google popup
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Get the ID token
                const idToken = await user.getIdToken();
                
                showStatus('Authenticating with backend...', 'info');
                
                // Send ID token to your backend
                const response = await fetch(`${API_BASE_URL}/auth/google`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        idToken: idToken
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('Authentication successful!', 'success');
                    displayUserInfo(data.data.user);
                    
                    // Store the custom token if needed for future requests
                    if (data.data.customToken) {
                        localStorage.setItem('customToken', data.data.customToken);
                    }
                } else {
                    showStatus(`Authentication failed: ${data.message}`, 'error');
                }

            } catch (error) {
                console.error('Sign in error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        });

        // Sign out
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showStatus('Signed out successfully', 'success');
                hideUserInfo();
                localStorage.removeItem('customToken');
            } catch (error) {
                console.error('Sign out error:', error);
                showStatus(`Sign out error: ${error.message}`, 'error');
            }
        });

        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                console.log('User signed in:', user);
            } else {
                // User is signed out
                console.log('User signed out');
                hideUserInfo();
            }
        });

        // Helper functions
        function showStatus(message, type) {
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function displayUserInfo(user) {
            userNameSpan.textContent = user.displayName || 'N/A';
            userEmailSpan.textContent = user.email || 'N/A';
            userUidSpan.textContent = user.uid || 'N/A';
            userInfoDiv.style.display = 'block';
        }

        function hideUserInfo() {
            userInfoDiv.style.display = 'none';
        }

        // Example function to make authenticated requests to your backend
        async function makeAuthenticatedRequest(endpoint, options = {}) {
            const user = auth.currentUser;
            if (!user) {
                throw new Error('User not authenticated');
            }

            const idToken = await user.getIdToken();
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                }
            };

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            return fetch(`${API_BASE_URL}${endpoint}`, finalOptions);
        }

        // Example usage of authenticated request
        async function loadBookmarks() {
            try {
                const response = await makeAuthenticatedRequest('/bookmarks', { method: 'GET' });
                const data = await response.json();
                console.log('Bookmarks:', data);
                
                // Display bookmarks in UI
                if (data.status === 'SUCCESS') {
                    const bookmarksList = document.getElementById('bookmarksList');
                    if (bookmarksList) {
                        bookmarksList.innerHTML = '';
                        data.bookmarks.forEach(group => {
                            const groupDiv = document.createElement('div');
                            groupDiv.innerHTML = `<h4>${group.title}</h4>`;
                            group.bookmarks.forEach(bookmark => {
                                const bookmarkDiv = document.createElement('div');
                                bookmarkDiv.innerHTML = `<a href="${bookmark.link}" target="_blank">${bookmark.name}</a>`;
                                groupDiv.appendChild(bookmarkDiv);
                            });
                            bookmarksList.appendChild(groupDiv);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading bookmarks:', error);
            }
        }

        // Example: Create a new bookmark
        async function createBookmark(title, url, groupId) {
            try {
                const response = await makeAuthenticatedRequest('/bookmarks', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: title,
                        url: url,
                        groupId: groupId
                    })
                });
                const data = await response.json();
                console.log('Created bookmark:', data);
                return data;
            } catch (error) {
                console.error('Error creating bookmark:', error);
                throw error;
            }
        }

        // Example: Create a new group
        async function createGroup(name) {
            try {
                const response = await makeAuthenticatedRequest('/groups', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: name
                    })
                });
                const data = await response.json();
                console.log('Created group:', data);
                return data;
            } catch (error) {
                console.error('Error creating group:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
